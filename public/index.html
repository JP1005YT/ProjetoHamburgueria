<!DOCTYPE html>
<html class="theme-light" lang="pt-BR"></html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Pedidos</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.1/css/bulma.min.css">
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
  </head>
<body>
  <div class="content person-head">
    <div class="person-btn-theme has-shadow" onclick="changeTheme()">
      <i class='bx bxs-brightness-half'></i>
    </div>
      <nav class="navbar is-spaced is-size-5 has-shadow" role="navigation">
        <div class="navbar-menu is-active">
          <div class="navbar-start is-centered" style="width: 100%; justify-content: center;">
            <a class="navbar-item is-active">Pedidos</a>
            <a class="navbar-item ml-5" onclick="changePages('clientes')">Clientes</a>
            <a class="navbar-item ml-5" onclick="changePages('produtos')">Produtos</a>
          </div>
        </div>
      </nav>
  </div>
  <div class="container is-widescreen active" id="novoPedido">
      <form class="box">
        <h1 class="title is-2">Novo Pedido</h1>
        <label class="label">Cliente</label>
        <div class="field has-addons person-field">
          <div class="control three">
            <div class="select">
              <select id="FilterClientes">
                <option value="nome">Nome</option>
                <option value="telefone">Telefone</option>
                <option value="endereco">Endereco</option>
              </select>
            </div>
          </div>
          <div class="control one">
            <div class="select">
              <select id="ListOfClients">
                <option>Selecione um cliente</option>
              </select>
            </div>
          </div>
          <div class="control two">
            <button class="button is-info" onclick="switchModalTwo()">
              <i class='bx bx-user-plus' style="font-size: 24px;"></i>
            </button>
          </div>
        </div>
        <label class="label">Forma de Pagamento</label>
        <div class="select person-w">
          <select class="person-w">
            <option value="0">0 - Pix</option>
            <option value="1">1 - Cartão</option>
            <option value="2">2 - Cardeneta</option>
          </select>
        </div>
        <label class="label">Observações</label>
        <input class="input" type="text" placeholder="Obs" />
        <label class="label">Produtos</label>
        <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth">
          <thead>
            <tr>
              <th class="person-prod has-text-centered"><abbr title="Produto">Prod</abbr></th>
              <th class="has-text-centered"><abbr title="Quantidade">Qnt</abbr></th>
              <th class="has-text-centered"><abbr title="Valor">Val</abbr></th>
              <th class="has-text-centered"><abbr title="Subtotal">SubT</abbr></th>
              <th></th>
            </tr>
          </thead>
          <tfoot>
            <th colspan="4" class="has-text-right">Taxa de Entrega: 10,50 Total: 95,94</th>
          <tbody id="tableProdutos">
          </tbody>
        </table>
        <div class="field is-grouped">
          <p class="control">
            <button class="button is-link" onclick="switchModal()">
              Adicionar
            </button>
          </p>
        </div>
        <div class="field is-grouped is-grouped-right">
          <p class="control">
            <button class="button is-primary">
              Finalizar
            </button>
          </p>
          <p class="control">
            <a class="button is-light">
              Cancelar
            </a>
          </p>
        </div>
        </form>
  </div>
  <div class="container is-widescreen disable" id="listaPedido">
    <div class="box">
      <h1 class="title is-2">Todos Pedidos</h1>
      <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth">
        <thead>
          <tr>
            <th class="person-prod has-text-centered"><abbr title="Numero do Pedido">N.Ped</abbr></th>
            <th class="has-text-centered"><abbr title="Metodo de Pagamento">M. Pag</abbr></th>
            <th class="has-text-centered"><abbr title="Items do Pedido">I. Ped</abbr></th>
            <th class="has-text-centered"><abbr title="Data Pedido">Data Pedido</abbr></th>
            <th class="has-text-centered"><abbr title="Valor Total">Val</abbr></th>
            <th></th>
          </tr>
        </thead>
        <tfoot>
          <th colspan="4" class="has-text-right">Total: 3 Pedidos</th>
        <tbody>
          <tr>
            <td>0001</td>
            <td class="has-text-right">Pix</td>
            <td class="has-text-right">3</td>
            <td class="has-text-right">25/07/2024</td>
            <td class="has-text-right">56,00</td>
            <td class="has-text-centered"><i class='bx bxs-trash-alt' ></i></td>
          </tr>
          <tr>
              <td>0002</td>
              <td class="has-text-right">Cartão</td>
              <td class="has-text-right">2</td>
              <td class="has-text-right">25/07/2024</td>
              <td class="has-text-right">22,00</td>
              <td class="has-text-centered"><i class='bx bxs-trash-alt' ></i></td>
          </tr>
            <tr>
                <td>0003</td>
                <td class="has-text-right">Pix</td>
                <td class="has-text-right">4</td>
                <td class="has-text-right">25/07/2024</td>
                <td class="has-text-right">132,54</td>
            <td class="has-text-centered"><i class='bx bxs-trash-alt' ></i></td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
  <div class="columns person-abbottom">
    <div class="column"></div>
    <div class="column is-half">
      <button class="button is-link is-outlined is-large person-w" onclick="changeMode()" id="switchButton">Meus Pedidos</button>
    </div>
    <div class="column"></div>
  </div>
  <div class="modal">
    <div class="modal-background" onclick="switchModal()"></div>
    <div class="modal-card person-modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Selecione os produtos</p>
        <button class="delete" aria-label="close" onclick="switchModal()"></button>
      </header>
      <section class="modal-card-body person-modal-body" id="prodBox">
      </section>
      <footer class="modal-card-foot person-modal-footer">
        <div class="buttons is-right">
          <button class="button is-success" onclick="syncSelectAndTable()">Salvar</button>
        </div>
      </footer>
    </div>
  </div>
  <div class="modal Two">
    <div class="modal-background" onclick="switchModalTwo()"></div>
    <div class="modal-card person-modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Adicionar Cliente</p>
        <button class="delete" aria-label="close" onclick="switchModalTwo()"></button>
      </header>
      <section class="modal-card-body">
        <form class="box" id="formNew">
          <label class="label">Nome</label>
          <input class="input" type="text" id="nome" name="nome">
          <label class="label">Telefone</label>
          <input class="input" type="text" id="telefone" name="telefone">
          <label class="label">Endereço</label>
          <input class="input" type="text" id="endereco" name="endereco">
          <label class="label">Data de Nascimento</label>
          <input class="input" type="date" id="dtnasc" name="dtnasc">
        </form>
      </section>
    </div>
  </div>
  <script>
    let modoNovo = true
    let clienteData , produtosData
    let produtosSelecionados = {}
    function switchModal(){
      document.querySelector(".modal").classList.toggle("is-active")
    }
    function switchModalTwo(){
      document.querySelector(".modal.Two").classList.toggle("is-active")
    }
    document.querySelector("form").addEventListener("submit",(e) => {
      e.preventDefault()
    })
    document.querySelector("#FilterClientes").addEventListener("change",(e) => {
      carregarClientes()
    })
    function changeMode(){
      if(modoNovo){
        document.querySelector("#novoPedido").classList.remove("active")
        document.querySelector("#novoPedido").classList.add("disable")
        document.querySelector("#listaPedido").classList.remove("disable")
        document.querySelector("#listaPedido").classList.add("active")
        modoNovo = false
        document.querySelector("#switchButton").innerHTML = "Novo Pedido"
      }else{
        document.querySelector("#novoPedido").classList.remove("disable")
        document.querySelector("#novoPedido").classList.add("active")
        document.querySelector("#listaPedido").classList.remove("active")
        document.querySelector("#listaPedido").classList.add("disable")
        modoNovo = true
        document.querySelector("#switchButton").innerHTML = "Meus Pedido"
      }
    }
    function changePages(local){
      window.location.href = './' + local
    }
    async function loadData(){
      const dados = await fetch('./getClientes',{
        method: "GET",
      });
      clienteData = await dados.json();
      const dadosProd = await fetch('./getProdutos',{
        method: "GET",
      });
      produtosData = await dadosProd.json();
      loadDOM()
    }
    async function loadDOM(){
      carregarClientes()
      carregarProdutos()
    }
    function carregarClientes(){
      const filter = document.querySelector("#FilterClientes").value
      const listclientsDOM = document.querySelector("#ListOfClients")
      const listaOrdenada = ordenarPorNome(clienteData)
      listclientsDOM.innerHTML = ""
      listaOrdenada.forEach(cliente => {
        const novaOpc = document.createElement("option")
        novaOpc.innerHTML = `${cliente[filter]}`
        novaOpc.value = cliente.id
        listclientsDOM.appendChild(novaOpc)
      });
    }
    function carregarProdutos(){
      produtosData.forEach((produto,index) => {
        const parser = new DOMParser();
        const htmlString = `
          <li class="card person-card-prod" prod-id="${produto.id}">
            <figure class="image is-square">
              <img src="./../images/${produto.image}" alt="Hamburger" />
            </figure>
            <span class='display' id='count'>0</span>
            <p class="has-text-centered">${produto.descricao} R$${produto.valor}</p>
          </li>
        `;
        const doc = parser.parseFromString(htmlString, 'text/html');
        const nodeObject = doc.body.firstChild;
        nodeObject.addEventListener("mouseenter",(e) => {
          e.target.classList.add("hover")
        })
        nodeObject.addEventListener("mouseleave",(e) => {
          e.target.classList.remove("hover")
        })
        nodeObject.addEventListener("click",(e) => {
          nodeObject.classList.add("clicked")
          id = nodeObject.getAttribute('prod-id')
          if(produtosSelecionados[id] === undefined){
            console.log('nao existe')
            produtosSelecionados[id] = 1
          }else{
            produtosSelecionados[id] += 1
          }

          atualizarDisplay()
        })
        nodeObject.addEventListener("contextmenu",(e) => {
          e.preventDefault()
          
          id = nodeObject.getAttribute('prod-id')
          if(produtosSelecionados[id] > 0){
            if(produtosSelecionados[id] == 1){
              nodeObject.classList.remove("clicked")
              produtosSelecionados[id] -= 1
            }else{
              produtosSelecionados[id] -= 1
            }
          }
          atualizarDisplay()
        })
        function atualizarDisplay(){
          idsSelecionados = Object.keys(produtosSelecionados)
          idsSelecionados.forEach(id => {
            if(nodeObject.getAttribute('prod-id') == id){
              nodeObject.querySelector(".display").innerHTML = produtosSelecionados[id]
            }
          })
        }
        document.querySelector("#prodBox").appendChild(nodeObject)
      });
    }
    loadData()
    async function SalvarCliente(){
      const formData = new FormData(document.querySelector("#formNew"))
      const data = Object.fromEntries(formData.entries());

      data.dtnasc = dateToSeconds(data.dtnasc)

      async function sendToServer(data){
        const result = fetch('./../newClient', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        }).then(response => response.json())
        return result
      }

      const resultado = await sendToServer(data)

      if(resultado.error){
        alert("erro informe o administrador")
      }else{
        window.location.reload()
      }
    }
    
    function syncSelectAndTable(){
      document.querySelector("#tableProdutos").innerHTML = ''
      Object.keys(produtosSelecionados).forEach(idProduto => {
        produtosData.forEach(produto => {
          if(produto.id == idProduto && produtosSelecionados[idProduto] > 0){
            const htmlString = `
            <tr>
              <td>${produto.descricao}</td>
              <td class="has-text-right">${produtosSelecionados[idProduto]}</td>
              <td class="has-text-right">${produto.valor}</td>
              <td class="has-text-right">${produto.valor * produtosSelecionados[idProduto]}</td>
              <td class="has-text-centered"><i class='bx bxs-trash-alt'></i></td>
            </tr>`;

            const template = document.createElement('template');
            template.innerHTML = htmlString.trim(); // Usar .trim() para remover espaços em branco extras

            const nodeObject = template.content.firstElementChild;

            document.querySelector("#tableProdutos").appendChild(nodeObject)
          }
        })
      })
      switchModal()
    }
  
  </script>
  <script src="main.js"></script>
</body>
</html>